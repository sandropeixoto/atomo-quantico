rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /entries/{entryId} {
      // Qualquer um pode ler posts públicos. Usuários logados podem ler seus próprios posts privados.
      allow read: if resource.data.isPublic == true || (request.auth != null && request.auth.uid == resource.data.authorId);
      
      // Usuários logados podem criar novas entradas para si mesmos.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId
                    && request.resource.data.likesCount == 0
                    && request.resource.data.commentsCount == 0;
      
      // O autor pode atualizar completamente seu post.
      // Qualquer usuário autenticado pode atualizar APENAS a contagem de likes e comentários.
      allow update: if request.auth != null && (
        (request.auth.uid == resource.data.authorId) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likesCount', 'commentsCount']))
      );

      // O autor pode deletar seu próprio post.
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;

      match /likes/{userId} {
        // A leitura de likes é permitida em posts públicos ou pelo autor do post.
        allow read: if get(/databases/$(database)/documents/entries/$(entryId)).data.isPublic == true 
                    || (request.auth != null && get(/databases/$(database)/documents/entries/$(entryId)).data.authorId == request.auth.uid);

        // Usuário só pode criar um like para si mesmo, e o ID do documento de like deve ser seu UID.
        allow create: if request.auth != null && request.auth.uid == request.resource.data.userId && request.auth.uid == userId;

        // Usuário só pode deletar seu próprio like.
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      match /comments/{commentId} {
        // A leitura de comentários é permitida em posts públicos ou pelo autor do post.
        allow read: if get(/databases/$(database)/documents/entries/$(entryId)).data.isPublic == true 
                    || (request.auth != null && get(/databases/$(database)/documents/entries/$(entryId)).data.authorId == request.auth.uid);
        
        // Usuário pode criar um comentário se for o autor do comentário.
        allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
        
        // O autor do comentário pode atualizá-lo ou deletá-lo.
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
      }
    }

    match /users/{userId} {
      // Qualquer um pode ler perfis de usuário (necessário para ver nomes de autor).
      allow read: if true;
      
      // Usuário só pode criar ou atualizar seu próprio perfil.
      allow create, update: if request.auth != null && request.auth.uid == userId;
    }
  }
}
