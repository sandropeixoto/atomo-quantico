rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /entries/{entryId} {
      // Allow reading public entries, or entries owned by the user.
      allow read: if resource.data.isPublic == true || (request.auth != null && request.auth.uid == resource.data.authorId);
      
      // Allow creating a new entry.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId
                    && request.resource.data.likesCount == 0
                    && request.resource.data.commentsCount == 0;
      
      // Allow the author to update their own entry.
      // Also, allow any authenticated user to update the likes and comments count,
      // as long as they don't change any other fields. This is crucial for the
      // like and comment transactions to succeed for non-authors.
      allow update: if request.auth != null && (
        (request.auth.uid == resource.data.authorId) ||
        (
          (
            request.resource.data.likesCount != resource.data.likesCount ||
            request.resource.data.commentsCount != resource.data.commentsCount
          ) &&
          request.resource.data.text == resource.data.text &&
          request.resource.data.authorId == resource.data.authorId &&
          request.resource.data.isPublic == resource.data.isPublic
        )
      );

      // Allow the author to delete their own entry.
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;

      match /likes/{likeId} {
        // Allow reading likes for any public post.
        // Allow creating/deleting your own like.
        allow read: if get(/databases/$(database)/documents/entries/$(entryId)).data.isPublic == true || (request.auth != null && get(/databases/$(database)/documents/entries/$(entryId)).data.authorId == request.auth.uid);
        allow create: if request.auth != null && request.auth.uid == likeId;
        allow delete: if request.auth != null && request.auth.uid == likeId;
      }

      match /comments/{commentId} {
        // Allow reading comments for any public post.
        // Allow creating a comment if authenticated.
        // Allow updating/deleting your own comment.
        allow read: if get(/databases/$(database)/documents/entries/$(entryId)).data.isPublic == true || (request.auth != null && get(/databases/$(database)/documents/entries/$(entryId)).data.authorId == request.auth.uid);
        allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
      }
    }

    match /users/{userId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
    }
  }
}
