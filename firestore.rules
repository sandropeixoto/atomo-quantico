rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /entries/{entryId} {
      // Allow reading public entries, or entries owned by the user.
      // This rule is evaluated for every document a query tries to return.
      // For public feeds, the query is `where('isPublic', '==', true)`, so every document
      // will pass the `resource.data.isPublic == true` check.
      // This also allows unauthenticated users to see the public feed.
      allow read: if resource.data.isPublic == true || (request.auth != null && request.auth.uid == resource.data.authorId);
      
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId
                    && request.resource.data.likesCount == 0
                    && request.resource.data.commentsCount == 0;
      
      allow update: if request.auth != null && request.auth.uid == resource.data.authorId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId;

      match /likes/{likeId} {
        // Allow reading likes for any public post.
        // Allow creating/deleting your own like.
        allow read: if get(/databases/$(database)/documents/entries/$(entryId)).data.isPublic == true || (request.auth != null && get(/databases/$(database)/documents/entries/$(entryId)).data.authorId == request.auth.uid);
        allow create: if request.auth != null && request.auth.uid == likeId;
        allow delete: if request.auth != null && request.auth.uid == likeId;
      }

      match /comments/{commentId} {
        // Allow reading comments for any public post.
        // Allow creating a comment if authenticated.
        // Allow updating/deleting your own comment.
        allow read: if get(/databases/$(database)/documents/entries/$(entryId)).data.isPublic == true || (request.auth != null && get(/databases/$(database)/documents/entries/$(entryId)).data.authorId == request.auth.uid);
        allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
      }
    }

    match /users/{userId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
    }
  }
}
